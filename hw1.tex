\documentclass{article}

% Language setting
% Replace `english' with e.g. `spanish' to change the document language
\usepackage[english]{babel}

% Set page size and margins
% Replace `letterpaper' with `a4paper' for UK/EU standard size
\usepackage[a4paper,top=2cm,bottom=2cm,left=3cm,right=3cm,marginparwidth=1.75cm]{geometry}

% Useful packages
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorlinks=true, allcolors=blue]{hyperref}
\usepackage{xcolor}
\usepackage{listings}

\colorlet{mygray}{black!30}
\colorlet{mygreen}{green!60!blue}
\colorlet{mymauve}{red!60!blue}

\lstset{
  backgroundcolor=\color{gray!10},  
  basicstyle=\ttfamily,
  columns=fullflexible,
  breakatwhitespace=false,      
  breaklines=true,                
  captionpos=b,                    
  commentstyle=\color{mygreen}, 
  extendedchars=true,              
  frame=single,                   
  keepspaces=true,             
  keywordstyle=\color{blue},      
  language=c++,                 
  numbers=none,                
  numbersep=5pt,                   
  numberstyle=\tiny\color{blue}, 
  rulecolor=\color{mygray},        
  showspaces=false,               
  showtabs=false,                 
  stepnumber=5,                  
  stringstyle=\color{mymauve},    
  tabsize=3,                                     
  title=\lstname 
}


\lstnewenvironment{code}[2][]{%
  \lstset{%
    numbers = left,
    title   = #2,
    #1,
  }%
}{}

\title{Homework 1}
\author{Steinarr Hrafn HÃ¶skuldsson}

\usepackage{fancyhdr}
\fancypagestyle{firststyle}
{
   \fancyhf{}
   \fancyhead[L]{Mechatronics 2}
   
   \renewcommand{\headrulewidth}{0pt} % removes horizontal header line
}
\begin{document}
\pagestyle{firststyle}
{\let\newpage\relax\maketitle}

\section{Eclipse}
Getting Eclipse to work was a hassle.

Installed as per the instructions but a few things caused issues beyond what the instructions covered.

The new Arduino IDE version 2 seems to not support the old bootloader of an Arduino Nano, easy solution was to just downgrade to the old version 1.8 .

The AVR plugin on Eclipse seems to have a bug and when creating a project with the AVR Toolchain it doesn't get registered as an AVR project causing Eclipse to refuse to even try uploading, giving error along the lines of: 'AVR project not opened'

I finally found a hack at https://sourceforge.net/p/avr-eclipse/support-requests/38/ which said to paste: 
\verb#<nature>de.innot.avreclipse.core.avrnature</nature># into the \verb".project" file. That fixed that issue and I was on my merry way to every other issue covered in the instructions.

\section{Blink Programs}
Two different blink programs were written, one for the Arduino IDE and another for the Eclipse bare bones.

The Arduino version is just the Arduino Blink example with the delays commented out.

The Eclipse bare bones version was taken from \verb"Baldurs8bitGuide.pdf" .

\section{Speed Comparisons}

The Arduino Nano was connected to a RTB2004 Oscilloscope to measure the time delay between blinks. As can be seen in figure \ref{hw1:fig:arduino} the Arduino version takes around $3\mu s$ to blink the LED, and not only that but once in a while it takes $9\mu s$. However as can be seen in figure \ref{hw1:fig:ecplise} the bare bones eclipse version takes only $250 ns$.

\section{Assembly Code}

The relevant Assembly instructions for the while loop are:

\begin{verbatim}
    	while (1)
	{
		PORTB = 1<<5 ;
  90:	e5 e2       	ldi	r30, 0x25	; 37
  92:	f0 e0       	ldi	r31, 0x00	; 0
  94:	80 e2       	ldi	r24, 0x20	; 32
  96:	80 83       	st	Z, r24
		PORTB = 0;
  98:	e5 e2       	ldi	r30, 0x25	; 37
  9a:	f0 e0       	ldi	r31, 0x00	; 0
  9c:	10 82       	st	Z, r1
  9e:	f8 cf       	rjmp	.-16     	; 0x90 <main+0x10>

\end{verbatim}
There are some hints that it might be able to run faster, flipping a register bit should be achievable in less than 4 instructions. And indeed it is. By changing the project build properties to heavily optimize the code we get the following assembly instructions.

\begin{verbatim}
    	while (1)
	{
		PORTB = 1<<5 ;
  84:	85 b9       	out	0x05, r24	; 5
		PORTB = 0;
  86:	15 b8       	out	0x05, r1	; 5
  88:	fd cf       	rjmp	.-6      	; 0x84 <main+0x4>
\end{verbatim}

Now each flip of the pin only takes one instruction. A screenshot of the oscilloscope with the optimized code running can be seen in figure \ref{hw1:fig:optimized}. Interestingly the loop is only 3 instructions,but runs at $4 Mhz$ suggesting that the jump instruction takes 2 clock cycles to execute.  
\section{Schematic - Altium}


\section{Final Project}
For the final project I propose creating CandyCounter a machine capable of counting candies as they fall in front of a light source.

The device will have a light source and a TSL1401-DB linescan camera. The device will be able to count candy, for example skittles or M&M as the fall between the light and the camera.

\subsection{Requirements}
The requirements for the device are
\begin{enumerate}
    \item Interface with a TSL1401-DB line scan camera
    \item be able to read the camera fast enough to discern candy as it falls
    \item Physically, the device should incorporate something to pour candy into, a bowl that the candy gathers into after being counted, a back light that the candy passes by and a camera.
\end{enumerate}

\subsection{Test plan}
\begin{enumerate}
    \item Pour a bag of candy into the device and get an accurate count.
    \item Take a picture of something with the camera.
    \item Count candies from a series of line scans
\end{enumerate}

\subsection{Subtasks}




    

\appendix
\section{Code}\label{appendix:code}

%\lstinputlisting[caption=timer\_msec.h]{EmbeddedSystemsAssignment2_1/src/timer_msec.h}



\end{document}

